<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>BrainByte ‚Äî Interactive Quiz Prototype (Confetti, Trophy & Sound)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- canvas-confetti for confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    :root{
      --bg-1: #0f0b2a;
      --bg-2: #181033;
      --accent-a: #8a5cff;   /* purple */
      --accent-b: #4fb4ff;   /* cyan */
      --accent-c: #ff63c8;   /* pink */
      --muted:#a9a3bf;
      --card-bg: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: 'Poppins', system-ui, sans-serif;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(138,92,255,0.12), transparent 8%),
                  radial-gradient(900px 400px at 90% 80%, rgba(79,180,255,0.07), transparent 7%),
                  linear-gradient(180deg,var(--bg-1), var(--bg-2));
      color: #eef0ff;
      min-height:100vh;
      position:relative;
      overflow:hidden;
    }
    .emoji-backdrop{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      overflow:hidden;
    }
    .emoji{
      position:absolute;
      font-size:22px;
      opacity:0.9;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
      will-change: transform, opacity;
      animation-name: fallSpin;
      animation-timing-function: linear;
      animation-iteration-count: infinite;
    }
    @keyframes fallSpin {
      0% { transform: translateY(-10vh) rotate(0deg) translateX(0); opacity:0 }
      10% { opacity:1 }
      100% { transform: translateY(110vh) rotate(720deg) translateX(30px); opacity:0.9 }
    }
    .wrap{
      max-width:1100px;
      margin:28px auto;
      padding:20px;
      position:relative;
      z-index:2;
    }
    header.siteHeader{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:18px;
      justify-content:space-between;
    }
    .logo {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoBadge{
      width:54px; height:54px; border-radius:12px;
      background: linear-gradient(135deg,var(--accent-a), var(--accent-b));
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 30px rgba(79,36,150,0.35), inset 0 -6px 18px rgba(255,255,255,0.04);
    }
    .logoBadge span{ font-size:20px; transform:translateY(-2px) }
    .siteTitle { font-weight:700; font-size:20px; letter-spacing:0.6px; color:#fff; }
    .siteSub { font-size:12px; color:var(--muted) }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 40px rgba(6,8,20,0.6);
      border: 1px solid rgba(255,255,255,0.03);
      margin-bottom:18px;
    }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .col{ flex:1; min-width:200px; }
    label.small{ font-size:12px; color:var(--muted) }
    input, select {
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.02);
      color: #fff;
      outline:none;
    }
    button {
      background: linear-gradient(90deg,var(--accent-a), var(--accent-b));
      border:none;
      padding:9px 14px;
      color:#fff;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      box-shadow: 0 8px 18px rgba(79,36,150,0.22);
    }
    .btn-ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted) }
    .controls{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .players{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
    .player{ width:220px; min-height:120px; border-radius:12px; padding:12px; background: var(--card-bg); border:1px solid rgba(255,255,255,0.03) }
    .player h3{ margin:0 0 8px 0; font-size:15px; color:#fff }
    .small.muted{ color:var(--muted) }
    /* Live quiz */
    #liveCard{ display:none }
    .timer{ font-weight:700; color:#fff; }
    .progressWrap{ height:10px; background: rgba(255,255,255,0.02); border-radius:999px; overflow:hidden; margin-top:8px }
    .progressBar{ height:100%; width:0%; background: linear-gradient(90deg, var(--accent-c), var(--accent-b)); transition: width 0.12s linear }
    .perPlayerChoices { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .perPlayerChoices button { font-size:13px; padding:8px 10px; border-radius:8px; background:#0c1222; border:1px solid rgba(255,255,255,0.03); color:#fff; cursor:pointer }
    .perPlayerChoices button.disabled { opacity:0.45; pointer-events:none }
    .choiceBtn { padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.02); color:#fff; cursor:default }
    .hide-live { display:none !important; }
    /* Trophy animation */
    .trophyWrap { display:flex; gap:14px; align-items:center; }
    .trophy {
      width:96px; height:96px; border-radius:18px;
      background: linear-gradient(135deg,#ffd66b,#ff9ac1);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 12px 30px rgba(255,154,92,0.18);
      transform: translateY(-20px) scale(0.8);
      opacity:0;
      transition: transform 520ms cubic-bezier(.2,.9,.2,1), opacity 420ms ease;
    }
    .trophy.show { transform: translateY(0) scale(1); opacity:1; }
    .trophy svg { width:56px; height:56px; }
    .winnerName { font-weight:700; font-size:18px; margin:0; color:#fff; }
    .winnerSub { color:var(--muted); margin:0; font-size:13px; }
    footer { color:var(--muted); text-align:center; margin-top:10px; font-size:13px }
    .muteBtn {
      background: transparent;
      border:1px solid rgba(255,255,255,0.04);
      color:var(--muted);
      padding:8px 10px;
      border-radius:8px;
      cursor:pointer;
    }
    @media(max-width:800px){
      .players{ justify-content:center }
    }
  </style>
</head>
<body>
  <div class="emoji-backdrop" id="emojiBackdrop" aria-hidden="true"></div>
  <div class="wrap" id="app" role="application">
    <header class="siteHeader">
      <div class="logo">
        <div class="logoBadge"><span>üß†</span></div>
        <div>
          <div class="siteTitle">BrainByte</div>
          <div class="siteSub">Fast, friendly classroom quizzes</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button id="muteBtn" class="muteBtn" title="Toggle sound">üîä Sound</button>
      </div>
    </header>
    <!-- SETUP -->
    <div class="card" id="setupCard">
      <h2 style="margin:0 0 10px 0">Setup Quiz</h2>
      <div class="row">
        <div class="col">
          <label class="small">Level</label><br>
          <select id="levelSelect"><option>O-Level</option><option>AS</option><option>A-Level</option></select>
        </div>
        <div class="col">
          <label class="small">Subject</label><br>
          <select id="subjectSelect"></select>
        </div>
        <div style="min-width:120px">
          <label class="small">Question time (sec)</label><br>
          <input id="timeLimit" type="number" min="5" value="12" />
        </div>
        <div style="min-width:220px">
          <label class="small">Add player</label><br>
          <input id="newName" placeholder="Player name" />
        </div>
        <div style="min-width:120px">
          <label class="small">&nbsp;</label><br>
          <select id="playerType"><option value="human">Human</option><option value="bot">Bot</option></select>
        </div>
      </div>
      <div class="controls">
        <button id="addPlayer">Add Player</button>
        <button id="addBotMany" class="btn-ghost">Add 3 Bots</button>
        <input id="howMany" type="number" min="1" value="5" style="width:70px; padding:8px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.04); color:#fff"/>
        <button id="addManyStudents" class="btn-ghost">Add N Students</button>
        <button id="startBtn">Start Quiz</button>
        <button id="resetBtn" class="btn-ghost">Reset</button>
      </div>
      <div class="players" id="playersContainer" aria-live="polite"></div>
    </div>
    <!-- LIVE QUIZ -->
    <div class="card" id="liveCard" role="region" aria-live="polite">
      <div class="row" style="align-items:flex-end">
        <div>
          <div class="small">Level & Subject</div>
          <div id="currentSubject" style="font-weight:600"></div>
        </div>
        <div style="margin-left:12px">
          <div class="small">Question</div>
          <div id="qText" style="font-size:18px; font-weight:700"></div>
        </div>
        <div style="margin-left:auto">
          <div class="small">Time left</div>
          <div class="timer" id="timeLeft">0</div>
        </div>
      </div>
      <div class="progressWrap" aria-hidden="false"><div id="progressBar" class="progressBar"></div></div>
      <div class="questionArea">
        <div class="choices" id="choices"></div>
      </div>
      <div class="row" style="margin-top:10px; align-items:center">
        <div>
          <button id="skipBtn" class="btn-ghost">Skip</button>
          <button id="endNow" class="btn-ghost">End Game Now</button>
        </div>
        <!-- ‚úÖ REMOVED: Keyboard answer UI -->
      </div>
      <div id="playerPanelsContainer" style="margin-top:12px"></div>
      <div class="log" id="gameLog"></div>
    </div>
    <!-- RESULTS -->
    <div class="card" id="resultsCard" style="display:none">
      <div class="trophyWrap">
        <div class="trophy" id="trophyEl" aria-hidden="true">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M48 10H16v6a12 12 0 0 0 12 12h8a12 12 0 0 0 12-12v-6z" fill="#fff" opacity="0.95"/>
            <path d="M20 18a8 8 0 0 1-8-8v-2h8v10z" fill="#ffd66b"/>
            <path d="M44 18a8 8 0 0 0 8-8v-2h-8v10z" fill="#ffd66b"/>
            <rect x="24" y="28" width="16" height="8" rx="2" fill="#fff" opacity="0.95"/>
            <path d="M28 44h8v6H28z" fill="#ffd66b"/>
          </svg>
        </div>
        <div>
          <p class="winnerName" id="winnerTitle">Winner: ‚Äî</p>
          <p class="winnerSub" id="winnerSub">Brainbits awarded</p>
        </div>
      </div>
      <h2 style="margin-top:14px">Game Over ‚Äî Leaderboard</h2>
      <div id="finalResults"></div>
      <div style="margin-top:12px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <button id="backSetup" class="btn-ghost">Back to Setup</button>
        <button id="playAgain" class="btn-ghost">Play Again</button>
        <a href="hub.html" style="text-decoration:none;">
          <button class="btn-ghost">‚Üê Back to Hub</button>
        </a>
      </div>
    </div>
    <!-- HISTORY & BALANCES -->
    <div class="card" id="historyCard">
      <div class="row">
        <div class="col">
          <h3 style="margin-top:0">History</h3>
          <div id="historyList" style="max-height:160px; overflow:auto; border-radius:8px; padding:8px; background:rgba(255,255,255,0.01)"></div>
          <div style="margin-top:8px"><button id="clearHistory" class="btn-ghost">Clear History</button></div>
        </div>
        <div class="col">
          <h3 style="margin-top:0">Brainbits (local)</h3>
          <div id="balancesList" style="max-height:160px; overflow:auto; border-radius:8px; padding:8px; background:rgba(255,255,255,0.01)"></div>
          <div style="margin-top:8px"><button id="clearBalances" class="btn-ghost">Clear Balances</button></div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>Leaderboard (hidden during live)</h3>
      <table id="leaderboard"><thead><tr><th>Player</th><th class="hide-live">Correct</th><th class="hide-live">Time (ms)</th><th class="hide-live">Score</th><th>Brainbits</th></tr></thead><tbody></tbody></table>
    </div>
    <footer>BrainByte ‚Äî playful learning. Backdrop: falling education emojis. </footer>
  </div>
  <script>
  (function(){
    // ===== small audio system using WebAudio =====
    let audioCtx = null;
    function ensureAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } }
    function playFanfare(muted) {
      if (muted) return;
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const freqs = [440, 550, 660];
      const master = ctx.createGain(); master.gain.setValueAtTime(0.0001, now);
      master.connect(ctx.destination);
      master.gain.exponentialRampToValueAtTime(0.6, now + 0.02);
      master.gain.exponentialRampToValueAtTime(0.001, now + 1.4);
      freqs.forEach((f,i) => {
        const o = ctx.createOscillator();
        o.type = 'sine';
        o.frequency.setValueAtTime(f, now + i * 0.02);
        const g = ctx.createGain(); g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.6 / freqs.length, now + 0.02);
        g.gain.exponentialRampToValueAtTime(0.001, now + 1.4);
        o.connect(g); g.connect(master);
        o.start(now + i * 0.02);
        o.stop(now + 1.35);
      });
    }
    function playPop(muted) {
      if (muted) return;
      ensureAudio();
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o = ctx.createOscillator();
      o.type = 'square';
      o.frequency.setValueAtTime(1200, now);
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.35, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
      o.connect(g); g.connect(ctx.destination);
      o.start(now); o.stop(now + 0.12);
    }
    function playPops(muted){
      if (muted) return;
      playPop(false);
      setTimeout(()=>playPop(false), 90);
      setTimeout(()=>playPop(false), 180);
    }
    // ===== confetti helper =====
    function burstConfetti(){
      if (typeof confetti !== 'undefined') {
        confetti({ particleCount: 40, spread: 60, origin: { y: 0.2 } });
        setTimeout(() => confetti({ particleCount: 120, spread: 120, origin: { y: 0.15 } }), 220);
      }
    }
    // ===== falling emojis =====
    const EMOJIS = ['üìö','üéì','üß†','üìù','üî¨','üìê','‚úèÔ∏è','üìñ','üß™','üß©'];
    const backdrop = document.getElementById('emojiBackdrop');
    function spawnEmoji(i){
      const el = document.createElement('div');
      el.className = 'emoji';
      el.textContent = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
      const left = Math.random()*100;
      el.style.left = left + 'vw';
      const size = 14 + Math.random()*28;
      el.style.fontSize = size + 'px';
      const duration = 6000 + Math.random()*9000;
      el.style.animationDuration = duration + 'ms';
      el.style.opacity = 0;
      backdrop.appendChild(el);
      setTimeout(()=> { el.remove(); }, duration + 400);
    }
    for(let i=0;i<18;i++) setTimeout(()=>spawnEmoji(i), i*300);
    setInterval(()=>spawnEmoji(), 700);
    // ===== quiz data (6 Q / subject) - FIXED MATH QUESTIONS =====
    const QUESTIONS_BY_LEVEL = {
      "O-Level": {
        "Math": [
          { text: "What is 7 √ó 8?", choices:["54","56","48","58"], correctIndex:1 },
          { text: "Solve: 12 + 15 =", choices:["25","26","27","28"], correctIndex:2 },
          { text: "What is 9 √ó 6?", choices:["54","52","48","56"], correctIndex:0 },
          { text: "Calculate 45 √∑ 5", choices:["9","8","7","6"], correctIndex:0 },
          { text: "What is 5¬≤?", choices:["10","15","25","20"], correctIndex:2 },
          { text: "Which is a prime number?", choices:["21","25","29","27"], correctIndex:2 }
        ],
        "Science": [
          { text: "Which planet is known as the Red Planet?", choices:["Venus","Saturn","Mars","Jupiter"], correctIndex:2 },
          { text: "Which gas do plants absorb for photosynthesis?", choices:["Oxygen","Carbon Dioxide","Nitrogen","Hydrogen"], correctIndex:1 },
          { text: "What is H2O commonly called?", choices:["Hydrogen peroxide","Water","Salt","Oxygen"], correctIndex:1 },
          { text: "Which organ pumps blood around the body?", choices:["Liver","Lungs","Heart","Kidney"], correctIndex:2 },
          { text: "What is the chemical symbol for Iron?", choices:["Ir","Fe","I","In"], correctIndex:1 },
          { text: "Which is a mammal?", choices:["Shark","Whale","Octopus","Frog"], correctIndex:1 }
        ],
        "English": [
          { text: "Who wrote 'Romeo and Juliet'?", choices:["Charles Dickens","William Shakespeare","Leo Tolstoy","Mark Twain"], correctIndex:1 },
          { text: "What is the plural of 'mouse'?", choices:["mouses","mouse","mice","mices"], correctIndex:2 },
          { text: "Choose the past tense of 'run'", choices:["run","ran","runned","running"], correctIndex:1 },
          { text: "Which is an adjective: 'The quick fox jumped.'", choices:["fox","jumped","quick","the"], correctIndex:2 },
          { text: "Synonym of 'Happy'", choices:["Sad","Joyful","Angry","Tired"], correctIndex:1 },
          { text: "Opposite of 'hot'?", choices:["warm","cold","cool","scorching"], correctIndex:1 }
        ],
        "History": [
          { text: "Which war ended in 1945?", choices:["WWI","WWII","Cold War","Napoleonic Wars"], correctIndex:1 },
          { text: "Who was the first President of the United States?", choices:["Abraham Lincoln","George Washington","John Adams","Thomas Jefferson"], correctIndex:1 },
          { text: "The Great Wall is mainly in which country?", choices:["India","China","Japan","Korea"], correctIndex:1 },
          { text: "Which ancient civilization built pyramids?", choices:["Romans","Greeks","Egyptians","Mayans"], correctIndex:2 },
          { text: "Which empire was ruled by emperors named 'Caesar'?", choices:["Persian","Roman","Ottoman","Inca"], correctIndex:1 },
          { text: "Who discovered America in 1492 (commonly taught)?", choices:["Vasco da Gama","Christopher Columbus","Ferdinand Magellan","Marco Polo"], correctIndex:1 }
        ]
      },
      "AS": {
        "Math": [
          { text: "Differentiate f(x)=x^2", choices:["2x","x^2","x","2"], correctIndex:0 },
          { text: "Integrate 2 dx", choices:["2x + C","x^2 + C","0","2 + C"], correctIndex:0 },
          { text: "If f(x)=3x, f'(x) = ?", choices:["3","x","1","0"], correctIndex:0 },
          { text: "Solve: 2x + 3 = 11", choices:["4","3","5","6"], correctIndex:0 },
          { text: "What is 2^5?", choices:["16","32","8","64"], correctIndex:1 },
          { text: "Logarithm: log10(100) = ?", choices:["1","2","10","100"], correctIndex:1 }
        ],
        "Science": [
          { text: "Chemical symbol for Sodium?", choices:["S","Na","K","So"], correctIndex:1 },
          { text: "pH < 7 indicates a", choices:["Neutral","Acidic","Basic","Alkaline"], correctIndex:1 },
          { text: "Which gas is most abundant in Earth's atmosphere?", choices:["Oxygen","Nitrogen","Carbon Dioxide","Hydrogen"], correctIndex:1 },
          { text: "Unit of force?", choices:["Joule","Newton","Watt","Pascal"], correctIndex:1 },
          { text: "Light travels fastest in", choices:["Glass","Water","Vacuum","Air"], correctIndex:2 },
          { text: "Which particle has negative charge?", choices:["Proton","Neutron","Electron","Photon"], correctIndex:2 }
        ],
        "English": [
          { text: "What is an oxymoron?", choices:["A type of poem","Contradictory terms used together","Long novel","A narrator"], correctIndex:1 },
          { text: "Choose correct article: '___ apple a day'", choices:["A","An","The","No article"], correctIndex:1 },
          { text: "Which is a metaphor?", choices:["He is a lion","He runs fast","He ate quickly","He sleeps"], correctIndex:0 },
          { text: "Identify the noun: 'The dog barked.'", choices:["The","dog","barked","."], correctIndex:1 },
          { text: "Antonym of 'ancient'?", choices:["old","modern","antique","archaic"], correctIndex:1 },
          { text: "Plural of 'analysis'?", choices:["analysises","analyses","analysi","analysis"], correctIndex:1 }
        ],
        "History": [
          { text: "The Treaty of Versailles was signed in which year?", choices:["1918","1919","1920","1917"], correctIndex:1 },
          { text: "Which revolution began in 1789?", choices:["American","French","Russian","Industrial"], correctIndex:1 },
          { text: "Napoleon was defeated at which battle?", choices:["Austerlitz","Waterloo","Trafalgar","Hastings"], correctIndex:1 },
          { text: "Which empire built the Colosseum?", choices:["Greek","Roman","Byzantine","Persian"], correctIndex:1 },
          { text: "Who led India to independence?", choices:["Jawaharlal Nehru","Mahatma Gandhi","Bhagat Singh","Sardar Patel"], correctIndex:1 },
          { text: "Which wall separated East and West Berlin?", choices:["Hadrian's Wall","Great Wall","Berlin Wall","Wailing Wall"], correctIndex:2 }
        ]
      },
      "A-Level": {
        "Math": [
          { text: "Evaluate limit as x‚Üí0 of sin(x)/x", choices:["0","1","‚àû","-1"], correctIndex:1 },
          // ‚úÖ REPLACED problematic eigenvalue question
          { text: "If A is a 2√ó2 matrix with trace 5 and determinant 6, what are possible eigenvalues?", 
            choices:["2 and 3","1 and 6","5 and 1","0 and 5"], correctIndex:0 },
          { text: "Integral of 1/x dx is", choices:["ln|x| + C","1/x + C","x + C","e^x + C"], correctIndex:0 },
          { text: "Solve: x^2 - 4 = 0", choices:["x=2 or -2","x=4","x=0","x=1"], correctIndex:0 },
          { text: "Derivative of sin(x) is", choices:["cos(x)","-sin(x)","sin(x)","-cos(x)"], correctIndex:0 },
          { text: "What is the binomial coefficient C(5,2)?", choices:["5","10","20","15"], correctIndex:1 }
        ],
        "Science": [
          { text: "Which particle has no electric charge?", choices:["Proton","Electron","Neutron","Positron"], correctIndex:2 },
          { text: "Gas law: PV = nRT: P stands for", choices:["Power","Pressure","Potential","Product"], correctIndex:1 },
          { text: "What is an isotope?", choices:["Different element","Same element, different neutrons","Ion","Molecule"], correctIndex:1 },
          { text: "Which organelle is site of respiration?", choices:["Chloroplast","Mitochondrion","Ribosome","Nucleus"], correctIndex:1 },
          { text: "Speed of light approx (m/s)?", choices:["3√ó10^6","3√ó10^8","3√ó10^5","3√ó10^7"], correctIndex:1 },
          { text: "pH of pure water at 25¬∞C is", choices:["7","0","14","1"], correctIndex:0 }
        ],
        "English": [
          { text: "A sonnet typically has how many lines?", choices:["12","14","16","10"], correctIndex:1 },
          { text: "What is iambic pentameter?", choices:["Meter with five iambs","A rhyme scheme","A stanza type","A chorus"], correctIndex:0 },
          { text: "Which is an example of alliteration?", choices:["She sells sea shells","He ran fast","Blue sky","Softly singing"], correctIndex:0 },
          { text: "Author of 'Pride and Prejudice'?", choices:["Charlotte Bront√´","Jane Austen","Emily Dickinson","George Eliot"], correctIndex:1 },
          { text: "What is a protagonist?", choices:["Main character","Villain","Minor character","Narrator"], correctIndex:0 },
          { text: "Tone in writing refers to", choices:["Sound","Author's attitude","Plot","Setting"], correctIndex:1 }
        ],
        "History": [
          { text: "The Renaissance began in which country?", choices:["France","Italy","England","Spain"], correctIndex:1 },
          { text: "Which document limited the power of the English king in 1215?", choices:["Constitution","Magna Carta","Bill of Rights","Treaty of Utrecht"], correctIndex:1 },
          { text: "Which revolution occurred in 1917?", choices:["French","Russian","Chinese","American"], correctIndex:1 },
          { text: "Who was the British PM during WWII?", choices:["Neville Chamberlain","Winston Churchill","Clement Attlee","Stanley Baldwin"], correctIndex:1 },
          { text: "The Cold War was mainly between the US and which country?", choices:["China","USSR","Germany","France"], correctIndex:1 },
          { text: "Who explored the Pacific for Spain in the 16th century?", choices:["Ferdinand Magellan","Marco Polo","Vasco da Gama","Christopher Columbus"], correctIndex:0 }
        ]
      }
    };
    const BALANCES_KEY = 'bb_balances_v1';
    const HISTORY_KEY = 'bb_history_v1';
    const MUTE_KEY = 'bb_muted_v1';
    const BRAINBITS_AWARD = 10;

    // DOM refs
    const levelSelect = document.getElementById('levelSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const timeLimitInput = document.getElementById('timeLimit');
    const playersContainer = document.getElementById('playersContainer');
    const addPlayerBtn = document.getElementById('addPlayer');
    const newNameInput = document.getElementById('newName');
    const playerTypeSelect = document.getElementById('playerType');
    const addBotManyBtn = document.getElementById('addBotMany');
    const addManyStudentsBtn = document.getElementById('addManyStudents');
    const howManyInput = document.getElementById('howMany');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const liveCard = document.getElementById('liveCard');
    const currentSubjectEl = document.getElementById('currentSubject');
    const qText = document.getElementById('qText');
    const choicesDiv = document.getElementById('choices');
    const timeLeft = document.getElementById('timeLeft');
    const progressBar = document.getElementById('progressBar');
    const playerPanelsContainer = document.getElementById('playerPanelsContainer');
    const gameLog = document.getElementById('gameLog');
    const resultsCard = document.getElementById('resultsCard');
    const finalResults = document.getElementById('finalResults');
    const backSetup = document.getElementById('backSetup');
    const playAgain = document.getElementById('playAgain');
    const trophyEl = document.getElementById('trophyEl');
    const winnerTitle = document.getElementById('winnerTitle');
    const winnerSub = document.getElementById('winnerSub');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const balancesList = document.getElementById('balancesList');
    const clearBalancesBtn = document.getElementById('clearBalances');
    const leaderboardTbody = document.querySelector('#leaderboard tbody');
    const muteBtn = document.getElementById('muteBtn');
    // ‚úÖ NEW: Skip and End buttons
    const skipBtn = document.getElementById('skipBtn');
    const endNow = document.getElementById('endNow');

    let setupPlayers = [];
    let runtimeState = null;
    let qIndex = 0;
    let qTimer = null;
    let qEndAt = 0;
    let answeringEnabled = false;

    function mkId(){ return Math.random().toString(36).slice(2,9); }
    function nowStr(){ return new Date().toLocaleString(); }
    function logMsg(m){ const d=document.createElement('div'); d.textContent=`[${nowStr()}] ${m}`; gameLog.prepend(d); }
    function loadBalances(){ try{ return JSON.parse(localStorage.getItem(BALANCES_KEY)||'{}'); }catch(e){ return {}; } }
    function saveBalances(b){ localStorage.setItem(BALANCES_KEY, JSON.stringify(b)); }
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]'); }catch(e){ return []; } }
    function saveHistory(h){ localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); }
    function getMuted(){ return localStorage.getItem(MUTE_KEY) === '1'; }
    function setMuted(v){ localStorage.setItem(MUTE_KEY, v ? '1' : '0'); updateMuteUI(); }
    function updateMuteUI(){
      const muted = getMuted();
      muteBtn.textContent = muted ? 'üîá Muted' : 'üîä Sound';
      muteBtn.style.opacity = muted ? 0.7 : 1;
    }

    muteBtn.onclick = () => { setMuted(!getMuted()); };

    function populateSubjects(){
      subjectSelect.innerHTML = '';
      const lvl = levelSelect.value;
      const subs = Object.keys(QUESTIONS_BY_LEVEL[lvl] || {});
      subs.forEach(s => { const opt = document.createElement('option'); opt.value=s; opt.textContent=s; subjectSelect.appendChild(opt); });
    }
    levelSelect.onchange = populateSubjects;
    populateSubjects();

    function renderSetupPlayers(){
      playersContainer.innerHTML = '';
      setupPlayers.forEach(p => {
        const div = document.createElement('div'); div.className='player'; div.id='ply_'+p.id;
        div.innerHTML = `<h3>${p.name} <span class="small muted">¬∑ ${p.type}</span></h3>
          <div class="small">Score: <strong>0</strong></div>
          <div style="margin-top:8px"><button data-id="${p.id}" class="removeBtn btn-ghost">Remove</button></div>`;
        playersContainer.appendChild(div);
      });
      document.querySelectorAll('.removeBtn').forEach(b=>{ b.onclick = ()=>{ const id=b.dataset.id; setupPlayers = setupPlayers.filter(x=>x.id!==id); renderSetupPlayers(); }; });
      refreshLeaderboard();
    }

    addPlayerBtn.onclick = () => {
      const nm = (newNameInput.value||'').trim() || undefined;
      const type = playerTypeSelect.value;
      addSetupPlayer(nm, type);
      newNameInput.value='';
    };

    function addSetupPlayer(name, type='human'){
      const id = mkId();
      setupPlayers.push({ id, name: name || (type==='bot' ? `Bot-${id.slice(0,4)}` : `Student-${id.slice(0,4)}`), type });
      renderSetupPlayers();
    }

    addBotManyBtn.onclick = () => { addSetupPlayer(undefined,'bot'); addSetupPlayer(undefined,'bot'); addSetupPlayer(undefined,'bot'); };

    addManyStudentsBtn.onclick = () => {
      let n = parseInt(howManyInput.value)||1;
      if(n<1) n=1;
      const baseNum = setupPlayers.filter(p => p.type === 'human' && p.name.startsWith('Student')).length + 1;
      for(let i=0; i<n; i++){
        addSetupPlayer(`Student ${baseNum + i}`, 'human');
      }
    };

    resetBtn.onclick = () => { if(!confirm('Reset players?')) return; setupPlayers = []; renderSetupPlayers(); };

    // ‚úÖ NEW: Skip and End functionality
    skipBtn.onclick = () => {
      if (answeringEnabled) {
        revealAndProceed();
      }
    };
    endNow.onclick = () => {
      if (answeringEnabled) {
        finishGame();
      }
    };

    function startQuiz(){
      if(setupPlayers.length < 2) return alert('Add at least 2 players.');
      const lvl = levelSelect.value; const subj = subjectSelect.value;
      const pool = (QUESTIONS_BY_LEVEL[lvl] && QUESTIONS_BY_LEVEL[lvl][subj]) ? QUESTIONS_BY_LEVEL[lvl][subj].slice() : [];
      if(!pool.length) return alert('No questions for selected level/subject.');
      const runtime = {
        level: lvl, subject: subj,
        timeLimitSec: Math.max(5, parseInt(timeLimitInput.value)||12),
        players: setupPlayers.map(p => ({ id:p.id, name:p.name, type:p.type, botConfig:{ accuracy:75, minDelay:400, maxDelay:1800 } })),
        questionSet: pool.map((q,i)=>({ ...q, id:i })).sort(()=>Math.random()-0.5)
      };
      beginLiveRun(runtime);
    }
    startBtn.onclick = startQuiz;

    function beginLiveRun(config){
      runtimeState = {
        config,
        players: config.players.map(p => ({ id:p.id, name:p.name, type:p.type, botConfig:p.botConfig, stats:{ correctCount:0, totalResponseTime:0, score:0 }, answeredThis:false, lastAnswer:null })),
        questionSet: config.questionSet.slice()
      };
      document.getElementById('setupCard').style.display = 'none';
      document.getElementById('historyCard').style.display = 'none';
      resultsCard.style.display = 'none';
      liveCard.style.display = 'block';
      document.querySelectorAll('.hide-live').forEach(el => el.classList.add('hide-live'));
      currentSubjectEl.textContent = `${config.level} ¬∑ ${config.subject}`;
      renderPlayerPanels();
      qIndex = 0;
      gameLog.innerHTML = '';
      showQuestion();
    }

    function renderPlayerPanels(){
      playerPanelsContainer.innerHTML = '';
      const playersDiv = document.createElement('div'); playersDiv.className='players';
      runtimeState.players.forEach(p => {
        const div = document.createElement('div'); div.className='player'; div.id='ply_'+p.id;
        div.innerHTML = `<h3>${p.name} <span class="small muted">¬∑ ${p.type}</span></h3>
          <div class="small hide-live">Correct: <strong id="correct_${p.id}">0</strong></div>
          <div class="small hide-live">Time: <strong id="tms_${p.id}">0</strong> ms</div>
          <div class="small hide-live">Score: <strong id="score_${p.id}">0</strong></div>
          <div id="choices_container_${p.id}" class="perPlayerChoices"></div>
          <div class="small muted" id="last_${p.id}" style="display:none"></div>`;
        playersDiv.appendChild(div);
      });
      playerPanelsContainer.appendChild(playersDiv);
      refreshLeaderboard();
    }

    function showQuestion(){
      if(qIndex >= runtimeState.questionSet.length){ finishGame(); return; }
      const q = runtimeState.questionSet[qIndex];
      qText.textContent = q.text;
      choicesDiv.innerHTML = '';
      q.choices.forEach((c, idx) => {
        const btn = document.createElement('button'); btn.className='choiceBtn'; btn.textContent = `${idx+1}. ${c}`; choicesDiv.appendChild(btn);
      });
      runtimeState.players.forEach(p => {
        p.answeredThis = false; p.lastAnswer = null;
        const cont = document.getElementById('choices_container_'+p.id);
        if(cont) cont.innerHTML = '';
        if(p.type === 'human'){
          const contEl = document.getElementById('choices_container_'+p.id);
          q.choices.forEach((choiceText, choiceIdx) => {
            const b = document.createElement('button'); b.textContent = `${choiceIdx+1}. ${choiceText}`; b.dataset.choice = choiceIdx;
            b.onclick = () => { if(!answeringEnabled) return; recordAnswer(p.id, choiceIdx); };
            contEl.appendChild(b);
          });
        }
      });
      runtimeState.players.forEach(p => { const last = document.getElementById('last_'+p.id); if(last) last.style.display = 'none'; });
      answeringEnabled = true;
      const timeLimitMs = Math.max(5, parseInt(runtimeState.config.timeLimitSec)||12) * 1000;
      const startTs = Date.now();
      qEndAt = startTs + timeLimitMs;
      updateProgressBar();
      clearInterval(qTimer);
      qTimer = setInterval(()=> {
        updateProgressBar();
        const left = Math.max(0, Math.round((qEndAt - Date.now())/1000));
        timeLeft.textContent = left;
        if(left <= 0) { clearInterval(qTimer); qTimer = null; revealAndProceed(); }
      }, 100);

      runtimeState.players.filter(p=>p.type==='bot').forEach(bot => {
        const willAnswer = Math.random()*100 < (bot.botConfig.accuracy || 75);
        if(!willAnswer) return;
        const delay = bot.botConfig.minDelay + Math.random()*(bot.botConfig.maxDelay - bot.botConfig.minDelay);
        setTimeout(()=> {
          if(!answeringEnabled || bot.answeredThis) return;
          const isCorrect = Math.random()*100 < (bot.botConfig.accuracy || 75);
          let choiceIdx;
          if(isCorrect) choiceIdx = q.correctIndex;
          else { const wrongs = q.choices.map((_,i)=>i).filter(i=>i!==q.correctIndex); choiceIdx = wrongs[Math.floor(Math.random()*wrongs.length)]; }
          recordAnswer(bot.id, choiceIdx);
        }, delay);
      });
    }

    // ‚úÖ Removed global key listener (no keyboard answer)

    function recordAnswer(playerId, choiceIdx){
      const p = runtimeState.players.find(x=>x.id===playerId);
      const q = runtimeState.questionSet[qIndex];
      if(!p || !q || !answeringEnabled) return;
      if(p.answeredThis) return;
      const now = Date.now();
      const timeLimitMs = Math.max(5, parseInt(runtimeState.config.timeLimitSec)||12) * 1000;
      const questionStart = qEndAt - timeLimitMs;
      const responseTime = Math.max(0, now - questionStart);
      p.answeredThis = true;
      p.lastAnswer = { choiceIdx, timeMs: responseTime, correct: choiceIdx === q.correctIndex };
      if(p.lastAnswer.correct){
        p.stats.correctCount += 1;
        p.stats.totalResponseTime += responseTime;
        let delta = 1000;
        const speedBonus = Math.max(0, Math.round(((timeLimitMs - responseTime) / timeLimitMs) * 500));
        delta += speedBonus;
        const anyCorrectBefore = runtimeState.players.some(px => px.lastAnswer && px !== p && px.lastAnswer.correct);
        if(!anyCorrectBefore) delta += 200;
        p.stats.score += delta;
      }
      const container = document.getElementById('choices_container_'+p.id);
      if(container) Array.from(container.children).forEach(btn => { btn.classList.add('disabled'); btn.disabled = true; });
      logMsg(`${p.name} answered`);
      const e1 = document.getElementById('correct_'+p.id); if(e1) e1.textContent = p.stats.correctCount;
      const e2 = document.getElementById('tms_'+p.id); if(e2) e2.textContent = p.stats.totalResponseTime;
      const e3 = document.getElementById('score_'+p.id); if(e3) e3.textContent = p.stats.score;
      const allAnswered = runtimeState.players.every(px => px.answeredThis);
      if(allAnswered){ clearInterval(qTimer); qTimer = null; revealAndProceed(); }
      refreshLeaderboard();
    }

    function updateProgressBar(){
      const total = Math.max(5, parseInt(runtimeState.config.timeLimitSec)||12) * 1000;
      const remaining = Math.max(0, qEndAt - Date.now());
      const pct = Math.max(0, Math.min(100, Math.round((remaining / total) * 100)));
      progressBar.style.width = pct + '%';
    }

    function revealAndProceed(){
      answeringEnabled = false;
      runtimeState.players.forEach(p=>{
        const cont = document.getElementById('choices_container_'+p.id);
        if(cont) Array.from(cont.children).forEach(b=>{ b.classList.add('disabled'); b.disabled = true; });
      });
      qIndex++;
      if(qIndex >= runtimeState.questionSet.length) finishGame();
      else setTimeout(()=> showQuestion(), 700);
    }

    function finishGame(){
      answeringEnabled = false;
      clearInterval(qTimer); qTimer = null;
      const results = runtimeState.players.map(p => ({ name: p.name, correctCount: p.stats.correctCount, totalResponseTime: p.stats.totalResponseTime, score: p.stats.score }));
      results.sort((a,b) => { if(b.correctCount !== a.correctCount) return b.correctCount - a.correctCount; return a.totalResponseTime - b.totalResponseTime; });
      const winner = results[0] || null;
      let awarded = 0;
      if(winner){
        awarded = BRAINBITS_AWARD;
        const balances = loadBalances();
        balances[winner.name] = (balances[winner.name] || 0) + awarded;
        saveBalances(balances);
        const hist = loadHistory();
        hist.push({ timestamp: nowStr(), level: runtimeState.config.level, subject: runtimeState.config.subject, players: results.map(r=>({ name:r.name, correct:r.correctCount })), winner: winner.name, awarded });
        saveHistory(hist);

        fetch('http://localhost:8000/ai/record-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: winner.name.replace(/\s+/g, '_').toLowerCase(),
            grade: "Secondary",
            subject: runtimeState.config.subject,
            topic: "Quiz",
            is_quiz: true,
            score: Math.round((winner.correctCount / runtimeState.config.questionSet.length) * 100),
            time_spent_sec: winner.totalResponseTime / 1000,
            correct_answers: winner.correctCount,
            total_questions: runtimeState.config.questionSet.length,
            engagement_minutes: runtimeState.config.questionSet.length * 0.5
          })
        }).catch(() => {});

        setTimeout(() => {
          fetch(`http://localhost:8000/ai/career-report/${winner.name.replace(/\s+/g, '_').toLowerCase()}?is_premium=true`)
            .then(res => res.json())
            .then(report => {
              let msg = `üß† **BrainByte Career AI**\nTop match: **${report.careers[0]}**\nSkills:\n`;
              for (let skill in report.skill_ratings) {
                msg += `- ${skill}: ${report.skill_ratings[skill]}/5\n`;
              }
              msg += `\nüí° ${report.explanations[0]}`;
              alert(msg);
            })
            .catch(() => {});
        }, 1500);
      }
      document.querySelectorAll('.hide-live').forEach(el => el.classList.remove('hide-live'));
      showResults(results, awarded);
    }

    function showResults(results, awarded){
      liveCard.style.display = 'none';
      finalResults.innerHTML = '';
      const tbl = document.createElement('table');
      tbl.innerHTML = '<tr><th>Player</th><th>Correct</th><th>Time (ms)</th><th>Score</th></tr>';
      results.forEach(r => {
        const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.name}</td><td>${r.correctCount}</td><td>${r.totalResponseTime}</td><td>${r.score}</td>`; tbl.appendChild(tr);
      });
      const winner = results[0] || null;
      winnerTitle.textContent = `Winner: ${winner ? winner.name : 'n/a'}`;
      winnerSub.textContent = `Brainbits awarded: ${winner ? awarded : 0}`;
      finalResults.appendChild(tbl);
      resultsCard.style.display = 'block';

      const muted = getMuted();
      trophyEl.classList.remove('show');
      void trophyEl.offsetWidth;
      setTimeout(()=> trophyEl.classList.add('show'), 60);

      if (!muted) {
        burstConfetti();
        playPops(false);
        setTimeout(()=> playFanfare(false), 240);
      } else {
        burstConfetti();
      }
      setTimeout(()=> burstConfetti(), 450);
    }

    backSetup.onclick = () => {
      resultsCard.style.display = 'none';
      document.getElementById('setupCard').style.display = 'block';
      document.getElementById('historyCard').style.display = 'block';
      document.querySelectorAll('.hide-live').forEach(el => el.classList.remove('hide-live'));
      renderSetupPlayers();
    };
    playAgain.onclick = () => {
      runtimeState.players.forEach(p => { p.stats={correctCount:0,totalResponseTime:0,score:0}; p.answeredThis=false; p.lastAnswer=null; });
      qIndex = 0;
      resultsCard.style.display = 'none';
      liveCard.style.display = 'block';
      gameLog.innerHTML = '';
      renderPlayerPanels();
      showQuestion();
    };

    function refreshLeaderboard(){
      const bal = loadBalances();
      leaderboardTbody.innerHTML = '';
      const list = (runtimeState && runtimeState.players) ? runtimeState.players : setupPlayers;
      list.forEach(p => {
        const tr = document.createElement('tr');
        const bb = bal[p.name] || 0;
        const correct = (p.stats && p.stats.correctCount) ? p.stats.correctCount : 0;
        const tms = (p.stats && p.stats.totalResponseTime) ? p.stats.totalResponseTime : 0;
        const score = (p.stats && p.stats.score) ? p.stats.score : 0;
        tr.innerHTML = `<td>${p.name}</td><td class="hide-live">${correct}</td><td class="hide-live">${tms}</td><td class="hide-live">${score}</td><td>${bb}</td>`;
        leaderboardTbody.appendChild(tr);
      });
    }

    function renderHistory(){ const h = loadHistory(); historyList.innerHTML=''; if(!h.length){ historyList.textContent='(no history)'; return;} h.slice().reverse().forEach(item=>{ const div=document.createElement('div'); div.innerHTML = `<strong>${item.timestamp}</strong> ¬∑ ${item.level} - ${item.subject} ¬∑ Winner: ${item.winner} (+${item.awarded} bb)<div class="small muted">${item.players.map(p=>p.name+':'+p.correct).join(' | ')}</div>`; div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)'; historyList.appendChild(div); }); }
    clearHistoryBtn.onclick = ()=>{ if(!confirm('Clear history?')) return; localStorage.removeItem(HISTORY_KEY); renderHistory(); };
    function renderBalances(){ const b = loadBalances(); balancesList.innerHTML=''; const keys = Object.keys(b); if(!keys.length){ balancesList.textContent='(no balances yet)'; return;} keys.forEach(k=>{ const div=document.createElement('div'); div.innerHTML = `<strong>${k}</strong> ¬∑ ${b[k]} bb`; div.style.padding='6px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)'; balancesList.appendChild(div); }) }
    clearBalancesBtn.onclick = ()=>{ if(!confirm('Clear balances?')) return; localStorage.removeItem(BALANCES_KEY); renderBalances(); refreshLeaderboard(); };

    renderHistory(); renderBalances();
    addSetupPlayer('You','human'); addSetupPlayer('BotA','bot'); addSetupPlayer('BotB','bot');
    renderSetupPlayers(); refreshLeaderboard();
    updateMuteUI();
  })();
  </script>
  <!-- Background Music -->
<audio id="bgMusic" loop>
  <source src="assets/audio/bg-music.mp3" type="audio/mpeg">
</audio>
<script>
  // Auto-play on first user interaction (required by browsers)
  document.addEventListener('click', function initAudio() {
    const bgMusic = document.getElementById('bgMusic');
    if (bgMusic) {
      // Unmute if previously muted
      bgMusic.muted = false;
      // Try to play
      bgMusic.play().catch(e => console.log("Audio play blocked:", e));
      // Remove listener after first play
      document.removeEventListener('click', initAudio);
    }
  }, { once: true });
</script>
<button id="musicToggle" style="position:fixed; top:10px; right:10px; z-index:100; padding:6px 10px; background:rgba(0,0,0,0.3); color:white; border:1px solid white; border-radius:5px;">
  üéµ Mute
</button>

<script>
  document.getElementById('musicToggle').addEventListener('click', function() {
    const bgMusic = document.getElementById('bgMusic');
    if (bgMusic) {
      bgMusic.muted = !bgMusic.muted;
      this.textContent = bgMusic.muted ? 'üîá Unmute' : 'üéµ Mute';
    }
  });
</script>
<!-- Background Music -->
<audio id="bgMusic" loop>
  <source src="assets/audio/bg-music.mp3" type="audio/mpeg">
</audio>
<script>
  // Auto-play on first user interaction (required by browsers)
  document.addEventListener('click', function initAudio() {
    const bgMusic = document.getElementById('bgMusic');
    if (bgMusic) {
      // Unmute if previously muted
      bgMusic.muted = false;
      // Try to play
      bgMusic.play().catch(e => console.log("Audio play blocked:", e));
      // Remove listener after first play
      document.removeEventListener('click', initAudio);
    }
  }, { once: true });
</script>
<button id="musicToggle" style="position:fixed; top:10px; right:10px; z-index:100; padding:6px 10px; background:rgba(0,0,0,0.3); color:white; border:1px solid white; border-radius:5px;">
  üéµ Mute
</button>

<script>
  document.getElementById('musicToggle').addEventListener('click', function() {
    const bgMusic = document.getElementById('bgMusic');
    if (bgMusic) {
      bgMusic.muted = !bgMusic.muted;
      this.textContent = bgMusic.muted ? 'üîá Unmute' : 'üéµ Mute';
    }
  });
</script>
</body>
</html>